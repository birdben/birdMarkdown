---
title: "ElasticSearch官网翻译_Aggregations"
date: 2017-07-13 14:48:39
tags: [Elasticsearch]
categories: [Search]
---

## Aggregations（聚合）

聚合框架有助于提供基于搜索查询的聚合数据。 它基于称为aggregations的简单构建块，可以组合以构建复杂的数据摘要。

聚合可以被视为在一组文档上构建分析信息的工作单元。 执行的上下文定义了该文档集合（例如，在执行的查询/搜索请求的过滤器的上下文中执行顶层聚合）。

有许多不同类型的聚合，每个都有自己的目的和产出。 为了更好地理解这些类型，将它们分解成四大系列往往更容易：

- Bucketing（桶）

构建桶的一系列聚合，其中每个桶与关键字和文档标准相关联。当执行聚合时，在上下文中的每个文档上评估所有桶标准，并且当标准匹配时，该文档被认为“落入”相关桶。在聚合过程结束时，我们将最终得到一个桶列表，每个桶都有一组“属于”（它）的文档。

- Metric（度量）

该聚合是在一组文档中跟踪和计算指标。

- Matrix（矩阵）

一组聚合，其操作在多个字段上，并根据从请求的文档字段中提取的值生成矩阵结果。与度量和桶聚合不同，此聚合系列还不支持脚本。

- Pipeline（管道）

该聚合是聚合其他聚合的输出及其相关度量。

接下来有趣的部分。由于每个桶有效地定义了一个文档集（所有文档属于桶），所以可以潜在地关联桶级别的聚合，并且它们将在该桶的上下文中执行。这是聚合的真正强大的地方：聚合可以嵌套！

###### 注意

> 桶聚合可以具有子聚合（桶或度量）。 将为其父聚合生成的桶计算子聚合。 嵌套聚合的级别/深度没有硬性限制（可以在“父”聚合下嵌套聚合，它本身就是另一个更高层聚合的子聚合）。

### Structuring Aggregations（聚合结构）

以下代码段捕获了聚合的基本结构：

```
"aggregations" : {
    "<aggregation_name>" : {
        "<aggregation_type>" : {
            <aggregation_body>
        }
        [,"meta" : {  [<meta_data_body>] } ]?
        [,"aggregations" : { [<sub_aggregation>]+ } ]?
    }
    [,"<aggregation_name_2>" : { ... } ]*
}
```

JSON中的aggregations对象（也可以使用关键字aggs）保存要计算的聚合。每个聚合与用户定义的逻辑名称相关联（例如，如果聚合计算平均价格，则将其命名为avg_price是有意义的）。这些逻辑名称也将用于唯一标识响应中的聚合。每个聚合都有一个特定类型（上述代码片段中的<aggregation_type>），通常是命名的聚合体内的第一个key。每种类型的聚合根据聚合的性质来定义其自己的主体（例如，特定字段上的avg聚合将定义计算平均值的字段）。在聚合类型定义的相同级别，可以选择定义一组附加聚合，尽管只有你定义的聚合具有桶性质才是有意义的。在这种情况下，你在桶聚合上定义子聚合就是在所有桶上进行的一次桶聚合。例如，如果在range聚合下定义了一组聚合，则将针对定义的range桶来计算子聚合。

### Values Source（值的来源）

一些聚合适用于从聚合文档中提取的值。 通常，这些值将从使用field设置的特定文档字段中提取。 还可以定义一个生成值的script（为每个文档）。

当为聚合配置field和script设置时，脚本将被视为value script。 虽然正常脚本在文档级别被求值（即，脚本可访问与文档相关联的所有数据），但value script将在value级别被求值。 在这种模式下，从配置的field和script中提取值，用于对这些值进行“转换”。

###### 注意

> 使用脚本时，也可以定义lang和params设置。 前者定义了使用的脚本语言（假设在Elasticsearch中可以使用正确的语言，默认情况下还是作为插件）。 后者可以将脚本中的所有"dynamic"表达式定义为参数，从而使脚本在调用之间保持自身是静态的（这将确保在Elasticsearch中使用缓存编译的脚本）。

Elasticsearch使用映射中的字段类型，以了解如何运行聚合并格式化响应。 然而，有两种情况，Elasticsearch无法弄清楚这些信息：未映射的字段（例如在跨多个索引的搜索请求的情况下，只有一些具有该字段的映射）和纯脚本。 对于这些情况，可以使用value_type选项给出Elasticsearch提示，该选项接受以下值：string，long（适用于所有整数类型），double（适用于所有十进制类型，如float或scaled_float），date，ip 和boolean。

参考文章：

- https://www.elastic.co/guide/en/elasticsearch/reference/5.4/search-aggregations.html
