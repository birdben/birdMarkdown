---
title: "ElasticSearch官网翻译_ReadingAndWritingDocuments"
date: 2017-05-29 18:33:55
tags: [Elasticsearch]
categories: [Search]
---

## Reading and Writing documents（读写文档）

### Introduction（介绍）

Elasticsearch中的每个索引都分为分片，每个分片可以有多个副本。这些副本称为replication group（复制组），并且在添加或删除文档时必须保持同步。如果我们没有这样做，将导致从一个副本读取的结果与从另一个读取的结果不一样。保持分片复制同步并从中读取的过程就是我们所说的data replication model（数据复制模型）。

Elasticsearch的数据复制模型基于primary-backup model（主备份模型），并在Microsoft Research的PacificA论文中得到很好的描述。该模型是以replication group（副本组）的单个副本为基础，实际上也就是主分片。其他副本称为replica shards（副本分片）。主要作为所有索引操作的主要入口点。负责验证和确保索引操作正确。一旦索引操作被主要接受，主要负责将操作复制到其他副本。

本节的目的是给出Elasticsearch replication model（复制模型）的高级概述，并讨论它对写操作和读操作之间的各种交互的影响。

### Basic write model（基础写模式）

Elasticsearch中的每个索引操作首先通过使用routing路由（通常基于文档ID）解析到replication group（副本组，包含主分片和副本分片）。 一旦确定了副本组，操作将在内部转发到（副本）组的当前主分片。 主分片负责验证操作并将其转发给其他副本。 由于副本可以脱机，因此不需要主分片复制到所有副本（分片）。 相反，Elasticsearch会维护一个应该接收操作的副本分片的列表。 该列表称为in-sync copies（同步副本），由master node（主节点）维护。 顾名思义，这些是一组“好”的副本分片，保证（这些分片）已经处理了所有已被用户确认的索引和删除操作。 主分片负责维护不变性（各个副本保持一致），因此必须将所有操作复制到此集合中的每个副本。

主分片遵循以下基本流程：

1. 验证传入操作，如果结构无效，则拒绝它（示例：对object字段指定一个数字值）
2. 在本地执行操作，即索引或删除相关文档。 这还将验证字段的内容并拒绝（如果需要）（示例：keyword值太长，无法在Lucene中进行索引）。
3. 将当前的操作转发到in-sync copies set（同步复制集）中每个副本。 如果有多个副本，这是并行完成的。
4. 一旦所有的副本都成功地执行了操作并对主分片作出响应，主分片向客户端确认请求成功完成。

#### Failure handling（处理失败）

索引过程中可能会出现许多问题 - 磁盘可能会损坏，节点可能会断开连接，或者某些配置错误可能导致副本上的操作失败，尽管它在主分片上成功。这些不常见，但是主分片必须对他们做出回应。

在主分片本身失败的情况下，托管主分片的节点（主分片所在的节点）将向主节点发送关于它的消息。索引操作将等待（默认情况下最多1分钟），以便主节点将其中一个副本分片升级为新的主分片。然后将该操作转发到新的主分片处理器。请注意，主节点还监控节点的运行状况，并可能决定主动降级主分片。这通常发生在主分片所在的节点与集群失去联系的情况下。有关详细信息，请参阅此处。

一旦在主分片上成功地执行了操作，该主分片必须处理在副本分片上潜在发生的错误。这可能是在副本分片上执行操作时发生的错误，也可能是因为网络阻塞，导致主分片无法转发操作到副本分片（或者副本分片无法返回结果给主分片）。所有这些都具有相同的最终结果：作为in-sync replica set（同步复制集合）的一部分的副本分片将丢失一个被确认的操作。为了避免出现不一致，主分片要向主节点发送消息，请求从in-sync replica set（同步复制集合）中删除有问题的分片。一旦主节点确认移除了该分片，主分片就会确认这次操作。请注意，主节点还将指示另一个节点开始构建一个新的副本分片，以便将系统恢复到正常状态。

在将操作转发到副本分片时，主分片将使用副本分片来验证它是否仍是一个活跃的主分片。如果主分片由于网络原因（或长GC）被隔离，在它真正被降级之前它会继续处理传入的索引操作。来自陈旧的主分片的操作将会被副本分片拒绝。当主分片接收到来自副本分片拒绝其请求的响应时，因为它不再是主分片，所以它将访问主节点，并将知道它已被替换。然后将操作路由到新的主分片。 

#### What happens if there are no replicas?（如果没有副本，会发生什么？）

> 这是一个有效的场景，由于索引配置可能会发生，或者因为所有的副本分片都失败了。 在这种情况下，主分片的处理操作没有任何外部验证，这似乎是有问题的。 另一方面，主分片自己不能使其他的分片失效，但是要求主节点代表它这样做。 这意味着主节点知道主分片是唯一的可用的副本。 因此，我们保证，主节点不会将任何其他（过时的）分片副本提升为新的主分片，并且索引到主分片上的任何操作都不会丢失。 当然，由于在这一点上，我们只运行单个数据副本，因此物理硬件问题可能会导致数据丢失。 有关缓解选项，请参阅“等待活动分片”一节。

### Basic read model（基础读模型）

Elasticsearch中的读取可以通过ID进行非常轻量级的查找，或者具有复杂的聚合的重度搜索请求将消耗大量cpu资源。primary-backup model（主备份模式）的一个优点是它保持所有分片副本是一致的（正在执行操作的除外）。因此，单个in-sync副本也可以服务读请求。

当节点接收到读请求时，该节点负责将其转发到保存相关分片的节点，并且整理响应以及响应客户端。我们称该节点为该请求的coordinating node（协调节点）。基本流程如下：

1. 将读请求解析为相关分片。请注意，由于大多数搜索将发送到一个或多个索引，它们通常需要从多个分片中读取，每个分片保存数据的不同的子集。
2. 从shard replication group（分片复制组）中选择每个相关分片的活动副本。它可以是主分片或副本分片。默认情况下，Elasticsearch只会简单的在这些副本分片（主分片或副本分片）之间循环。
3. 将分片级读取请求发送到所选副本（主分片或副本分片）。
4. 合并结果并响应。请注意，在通过ID查找的情况下，只有一个分片是相关的，并且可以跳过该步骤。

#### Failure handling（故障处理）

当一个分片未能响应读请求时，coordinating node（协调节点）将从同一复制组中选择另一个副本（主分片或副本分片），并将该分片级搜索请求发送给该副本（主分片或副本分片）替代不可用的副本。 重复故障可能是没有分片副本可用。 在某些情况下，如_search，Elasticsearch将更愿意快速响应，尽管只有部分结果，而不是等待该问题得到解决（是否是部分结果在响应的header中的_shards中指出）。

### A few simple implications（一些简单的含义）

这些基本流程中的每一个确定了Elasticsearch作为系统在读取和写入是如何表现的。 此外，由于可以同时执行读写请求，所以这两个基本流程相互影响。 这有一些固有的含义：

- Efficient reads（高效读取）

在正常操作下，每个相关复制组只执行一次读取操作。 只有在故障条件下，同一个分片的多个副本才能执行相同的搜索。

- Read unacknowledged（读取未确认）

由于主分片首先在本地进行索引，然后请求副本分片，所以并发读取可以在（向客户端响应）确认之前已经看到更改。

- Two copies by default（默认为两份）

该模型可以容错，同时只保留两个数据副本。 这与quorum-based系统相反，其中容错的最小副本数为3。

### Failures（故障）

在失败的情况下，可以进行以下操作：

- A single shard can slow down indexing（单个分片可能会减慢索引速度）

因为主分片等待每个操作中设置的in-sync copies set（同步中副本集）中的所有副本，所以单个缓慢的分片可能会减慢整个复制组的速度。 这是我们为上述读取效率付出的代价。 当然，单个缓慢的分片也会减慢已经发送给它的unlucky searches（不利的搜索）。

- Dirty reads（脏读）

脱离集群的主分片可以暴露不被确认的写入。 这是由于脱离的主分片只有在向其副本分片发送请求或者向主节点发送请求时才会被脱离。 在这一点上，操作已经被索引到主分片并且可以通过并发读取被读取到。 Elasticsearch通过每秒钟（默认情况下）ping主节点来减轻这种风险，如果没有主节点，则拒绝索引操作。

### The Tip of the Iceberg（一点建议）

本文档提供了Elasticsearch如何处理数据的高级概述。 当然，底层实现下还有更多的事情。 诸如primary terms（主要的词条），cluster state publishing（集群状态发布）和master election（主选举）等都起到了保持系统运行正常的作用。 本文档不包括已知和重要的bugs（已关闭和打开）。 我们认识到GitHub很难跟上。 为了帮助这些人，我们在我们的网站上维护一个专用的resiliency page。 我们强烈建议您阅读。

参考文章：

- https://www.elastic.co/guide/en/elasticsearch/reference/5.4/docs-replication.html
